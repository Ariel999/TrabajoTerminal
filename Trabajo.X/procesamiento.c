#include <xc.h>
#include <dsp.h>
#include <math.h>
#include "defs.h"
#define M_PI 3.14159265358979323846

typedef struct{
	float real;
	float imag;
} complejo;
extern fractcomplex valCH0[FFT_BLOCK_LENGTH]
__attribute__ ((eds, space(ymemory), aligned (FFT_BLOCK_LENGTH * 2 *2)));
extern fractcomplex valCH1[FFT_BLOCK_LENGTH]
__attribute__ ((eds, space(ymemory), aligned (FFT_BLOCK_LENGTH * 2 *2)));

extern fractional hamming[FFT_BLOCK_LENGTH] 	
 __attribute__ ((section (".xbss, bss, xmemory"), aligned (FFT_BLOCK_LENGTH* 2 *2)));

 #ifndef FFTTWIDCOEFFS_IN_PROGMEM
 fractcomplex twiddleFactors[FFT_BLOCK_LENGTH/2] 	
 __attribute__ ((section (".xbss, bss, xmemory"), aligned (FFT_BLOCK_LENGTH*2)));
 #else
 extern const fractcomplex twiddleFactors[FFT_BLOCK_LENGTH/2]	/* Twiddle Factor array in Program memory */
 __attribute__ ((space(prog), aligned (FFT_BLOCK_LENGTH*2)));
 #endif

int	peakFrequencyBin = 0;				/* Declare post-FFT variables to compute the */
unsigned long peakFrequency = 0;
extern float lnCH0, lnCH1;
fractional output[FFT_BLOCK_LENGTH];
const float prueba[] = 
{
         -0.13514,     -0.23123,      -0.3033,      -0.3033,      -0.2973,     -0.32132,      -0.3033,     -0.27928,     -0.22523,      -0.3033,     -0.37538,     -0.26727,     -0.26727,    -0.087087,     0.045045,     0.033033,     0.099099,      0.14715,     0.021021,     0.051051,     0.033033,    -0.099099,    -0.051051,    -0.039039,    -0.033033,    -0.075075,     -0.18919,     -0.32733,     -0.33934,     -0.20721,    -0.093093,     0.021021,     0.039039,     0.063063,      0.12312,      0.18318,      0.25526,      0.38739,      0.41141,      0.29129,       0.1952,      0.16517,      0.11111,     0.045045,     0.099099,     0.087087,      0.10511,     0.027027,     -0.14715,     -0.20721,     -0.33934,     -0.10511,      0.14114,      0.21321,       0.2973,      0.28529,      0.13514,     0.045045,     0.063063,     0.039039,      0.11111,      0.18919,      0.18318,      0.32132,      0.27928,      0.25526,      0.17718,      0.11111,      0.10511,     0.069069,     0.099099,      0.16517,      0.13514,      0.10511,     0.021021,     0.033033,     0.027027,     0.045045,     0.003003,     -0.12312,     -0.21922,     -0.30931,     -0.38138,     -0.38739,      -0.3994,     -0.32733,     -0.36937,     -0.45345,     -0.39339,     -0.36336,     -0.48949,     -0.39339,     -0.26727,      -0.1952,     -0.10511,    -0.087087,     -0.15916,     -0.24324,      -0.2973,     -0.28529,     -0.30931,     -0.20721,     -0.12312,     -0.18318,     -0.23123,     -0.24925,     -0.36937,     -0.34535,     -0.34535,     -0.36937,     -0.33333,     -0.28529,     -0.34535,     -0.35736,     -0.34535,     -0.36336,     -0.38138,     -0.36937,     -0.32132,     -0.32132,     -0.40541,     -0.48949,     -0.56156,     -0.56757,     -0.56156,     -0.50751,     -0.52553,      -0.6036,      -0.6997,     -0.78378,     -0.84384,      -0.7958,     -0.81381,     -0.92192,     -0.90991,     -0.86186,      -0.8018,     -0.87387,     -0.96396,     -0.98198,           -1,     -0.77177,     -0.68769,     -0.77778,     -0.81381,     -0.81381,      -0.8979,     -0.75375,     -0.56757,     -0.71171,     -0.80781,     -0.77177,     -0.71171,     -0.59159,     -0.56156,     -0.51952,     -0.54354,     -0.45946,     -0.35736,     -0.31532,     -0.30931,     -0.31532,     -0.33333,     -0.45345,     -0.52553,     -0.51351,     -0.48949,     -0.46547,     -0.50751,     -0.46547,     -0.52553,     -0.62162,      -0.5976,     -0.64565,     -0.71171,     -0.60961,     -0.57958,     -0.59159,     -0.44144,     -0.40541,     -0.50751,     -0.51952,     -0.38739,     -0.35736,     -0.32132,     -0.24925,      -0.2973,     -0.35135,     -0.32733,     -0.21321,     -0.18318,     -0.15916,     -0.17718,     -0.23724,      -0.2973,     -0.27928,     -0.26727,      -0.3994,     -0.44745,     -0.38739,     -0.32733,     -0.28529,     -0.38138,     -0.35736,     -0.36336,     -0.32733,     -0.25526,     -0.26126,     -0.26126,     -0.21922,     -0.13514,    -0.063063,     0.063063,      0.16517,      0.13514,      0.10511,     0.087087,     0.033033,     -0.13514,     -0.18318,     -0.16517,    -0.063063,    -0.063063,     0.033033,     0.057057,     0.033033,      0.14715,      0.15916,     0.069069,      0.13514,      0.14114,     0.033033,     0.027027,     0.009009,    -0.039039,    -0.039039,     0.015015,     0.069069,      0.14715,       0.2012,      0.18318,      0.11712,      0.12913,      0.12913,      0.14114,      0.18318,      0.25526,      0.23123,      0.10511,     0.051051,     0.045045,     0.045045,      0.15916,       0.3033,      0.31532,      0.26727
};
const float prueba1[] = 
{
 -0.29123,-0.40351,-0.43158,-0.45965,-0.41053,-0.45965,-0.52281,-0.43158,-0.35439,-0.42456,-0.45965,-0.34035,-0.39649,-0.29123,-0.19298,-0.24912,-0.22807,-0.20702,-0.21404,-0.20702,-0.087719,-0.052632,-0.052632,-0.15789,-0.17193,-0.20702,-0.36842,-0.38947,-0.34737,-0.32632,-0.27719,-0.18596,-0.2,-0.17895,-0.15789,-0.19298,-0.24211,-0.13684,-0.10877,-0.080702,-0.059649,0.038596,0.017544,-0.017544,-0.0035088,0.045614,0.10175,0.024561,0.052632,-0.0035088,-0.10175,0.15789,0.3614,0.45965,0.66316,0.76842,0.74737,0.74035,0.75439,0.84561,0.8386,0.81754,0.84561,0.85263,0.79649,0.77544,0.74737,0.73333,0.70526,0.60702,0.51579,0.52281,0.48772,0.39649,0.32632,0.36842,0.39649,0.4386,0.40351,0.25614,0.080702,-0.017544,-0.10175,-0.13684,-0.16491,-0.087719,-0.15088,-0.24912,-0.14386,-0.12982,-0.24912,-0.087719,0.024561,0.10877,0.21404,0.19298,0.094737,0.12982,0.12982,0.13684,0.16491,0.23509,0.20702,0.059649,-0.080702,-0.15789,-0.25614,-0.18596,-0.11579,-0.080702,0.0035088,0.080702,0.10877,0.15789,0.22105,0.25614,0.22105,0.24912,0.34035,0.38947,0.31228,0.17895,0.14386,0.12281,0.15088,0.17895,0.12281,0.045614,-0.024561,-0.094737,-0.12281,-0.17895,-0.24211,-0.34737,-0.51579,-0.52982,-0.59298,-0.77544,-0.99298,-1,-0.91579,-0.7614,-0.62105,-0.68421,-0.80351,-0.80351,-0.86667,-0.62807,-0.40351,-0.55789,-0.68421,-0.78246,-0.74737,-0.61404,-0.62105,-0.53684,-0.49474,-0.33333,-0.21404,-0.17895,-0.27018,-0.38246,-0.41053,-0.50175,-0.49474,-0.41053,-0.37544,-0.41053,-0.51579,-0.50175,-0.53684,-0.6,-0.53684,-0.49474,-0.4386,-0.33333,-0.31228,-0.41053,-0.45965,-0.50175,-0.57895,-0.60702,-0.45965,-0.29825,-0.32632,-0.29825,-0.29825,-0.41053,-0.44561,-0.38246,-0.38246,-0.32632,-0.27719,-0.27018,-0.39649,-0.41754,-0.36842,-0.48772,-0.42456,-0.29123,-0.33333,-0.3614,-0.52982,-0.57895,-0.56491,-0.55088,-0.50175,-0.48772,-0.41754,-0.39649,-0.36842,-0.33333,-0.31228,-0.20702,-0.2,-0.22807,-0.23509,-0.31228,-0.50877,-0.57895,-0.4807,-0.40351,-0.34737,-0.20702,-0.12281,-0.087719,-0.010526,-0.15088,-0.34737,-0.34737,-0.32632,-0.27719,-0.22105,-0.13684,-0.10175,-0.10175,-0.087719,-0.11579,-0.15088,-0.13684,-0.11579,-0.052632,0.010526,0.0035088,-0.0035088,-0.024561,0.045614,0.2,0.15789,0.17193,0.2,0.14386,0.13684,0.10877,0.087719,0.12982
};
/*const float prueba[] = 
{
    0.000000,0.290285,0.555570,0.773010,0.923880,0.995185,0.980785,0.881921,
    0.707107,0.471397,0.195090,-0.098017,-0.382683,-0.634393,-0.831470,
    -0.956940,-1.000000,-0.956940,-0.831470,-0.634393,-0.382683,-0.098017,
    0.195090,0.471397,0.707107,0.881921,0.980785,0.995185,0.923880,
    0.773010,0.555570,0.290285,0.000000,-0.290285,-0.555570,-0.773010,
    -0.923880,-0.995185,-0.980785,-0.881921,-0.707107,-0.471397,-0.195090,
    0.098017,0.382683,0.634393,0.831470,0.956940,1.000000,0.956940,
    0.831470,0.634393,0.382683,0.098017,-0.195090,-0.471397,-0.707107,
    -0.881921,-0.980785,-0.995185,-0.923880,-0.773010,-0.555570,-0.290285,
    -0.000000,0.290285,0.555570,0.773010,0.923880,0.995185,0.980785,
    0.881921,0.707107,0.471397,0.195090,-0.098017,-0.382683,-0.634393,
    -0.831470,-0.956940,-1.000000,-0.956940,-0.831470,-0.634393,-0.382683,
    -0.098017,0.195090,0.471397,0.707107,0.881921,0.980785,0.995185,
    0.923880,0.773010,0.555570,0.290285,0.000000,-0.290285,-0.555570,
    -0.773010,-0.923880,-0.995185,-0.980785,-0.881921,-0.707107,-0.471397,
    -0.195090,0.098017,0.382683,0.634393,0.831470,0.956940,1.000000,
    0.956940,0.831470,0.634393,0.382683,0.098017,-0.195090,-0.471397,
    -0.707107,-0.881921,-0.980785,-0.995185,-0.923880,-0.773010,-0.555570,
    -0.290285,-0.000000,0.290285,0.555570,0.773010,0.923880,0.995185,
    0.980785,0.881921,0.707107,0.471397,0.195090,-0.098017,-0.382683,
    -0.634393,-0.831470,-0.956940,-1.000000,-0.956940,-0.831470,-0.634393,
    -0.382683,-0.098017,0.195090,0.471397,0.707107,0.881921,0.980785,
    0.995185,0.923880,0.773010,0.555570,0.290285,0.000000,-0.290285,
    -0.555570,-0.773010,-0.923880,-0.995185,-0.980785,-0.881921,-0.707107,
    -0.471397,-0.195090,0.098017,0.382683,0.634393,0.831470,0.956940,
    1.000000,0.956940,0.831470,0.634393,0.382683,0.098017,-0.195090,
    -0.471397,-0.707107,-0.881921,-0.980785,-0.995185,-0.923880,-0.773010,
    -0.555570,-0.290285,-0.000000,0.290285,0.555570,0.773010,0.923880,
    0.995185,0.980785,0.881921,0.707107,0.471397,0.195090,-0.098017,
    -0.382683,-0.634393,-0.831470,-0.956940,-1.000000,-0.956940,-0.831470,
    -0.634393,-0.382683,-0.098017,0.195090,0.471397,0.707107,0.881921,
    0.980785,0.995185,0.923880,0.773010,0.555570,0.290285,-0.000000,
    -0.290285,-0.555570,-0.773010,-0.923880,-0.995185,-0.980785,-0.881921,
    -0.707107,-0.471397,-0.195090,0.098017,0.382683,0.634393,0.831470,
    0.956940,1.000000,0.956940,0.831470,0.634393,0.382683,0.098017,
    -0.195090,-0.471397,-0.707107,-0.881921,-0.980785,-0.995185,-0.923880,
    -0.773010,-0.555570,-0.290285
};*/

void procesarMuestras( char canal )
{
    int i = 0;
    float alfa = 0;
    fractional magnitudAlfa;
    
    //Ventana de Hamming
    if( canal == 0 )
        VectorWindow(FFT_BLOCK_LENGTH,&valCH0[0].real,&valCH0[0].real,&hamming[0]);
    else if( canal == 1 )
        VectorWindow(FFT_BLOCK_LENGTH,&valCH1[0].real,&valCH1[0].real,&hamming[0]);
    
    //Factores de giro para la FFT
    #ifndef FFTTWIDCOEFFS_IN_PROGMEM					
    TwidFactorInit (LOG2_BLOCK_LENGTH, &twiddleFactors[0], 0);	
    #endif
    
    //Corrimiento para mantener datos entre -0.5 y 0.5
    for ( i = 0; i < FFT_BLOCK_LENGTH; i++ )
    {
        if( canal == 0 )
        {
            valCH0[i].real = valCH0[i].real >> 1 ;		
            valCH0[i].imag = 0;	
        }
        else if( canal == 1 )
        {
            valCH1[i].real = valCH1[i].real >> 1 ;		
            valCH1[i].imag = 0;
        }
    }
    
    //FFT
    #ifndef FFTTWIDCOEFFS_IN_PROGMEM
    FFTComplexIP (LOG2_BLOCK_LENGTH, &sigCmpx[0], &twiddleFactors[0], COEFFS_IN_DATA);
    #else
    if( canal == 0 )
        FFTComplexIP (LOG2_BLOCK_LENGTH, &valCH0[0], (fractcomplex *) __builtin_psvoffset(&twiddleFactors[0]), (int) __builtin_psvpage(&twiddleFactors[0]));
    else if( canal == 1 )
        FFTComplexIP (LOG2_BLOCK_LENGTH, &valCH1[0], (fractcomplex *) __builtin_psvoffset(&twiddleFactors[0]), (int) __builtin_psvpage(&twiddleFactors[0]));
    #endif
    
    //Reordenar los datos de la FFT
    if ( canal == 0 )
        BitReverseComplex (LOG2_BLOCK_LENGTH, &valCH0[0]);
    else if( canal == 1 )
        BitReverseComplex (LOG2_BLOCK_LENGTH, &valCH1[0]);
    
    //Magnitud a la FFT
    if ( canal == 0 )
        SquareMagnitudeCplx(FFT_BLOCK_LENGTH, &valCH0[0], output);
    else if( canal == 1 )
        SquareMagnitudeCplx(FFT_BLOCK_LENGTH, &valCH1[0], output);
    
    
    VectorMax(FFT_BLOCK_LENGTH/2, output, &peakFrequencyBin);
    
    peakFrequency = peakFrequencyBin*(FRECUENCIA_MUESTREO/FFT_BLOCK_LENGTH);
    
    //Acumular el promedio en la banda alfa
    magnitudAlfa = output[8] + output[9] + output[10] + output[11] + output[12];
    magnitudAlfa /= 5;
    alfa = ((float)magnitudAlfa) / (32768);
    
    //Calcular el logaritmo natural del promedio
    if( canal == 0)
        lnCH0 = logf(alfa);
    else if( canal == 1 )
        lnCH1 = logf(alfa);
    //while(1);
    
    return;
}